<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LLVM源码分析系列(0): formatv | CanftIn's Blog</title><meta name=keywords content><meta name=description content="这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后"><meta name=author content="矩木"><link rel=canonical href=https://canftin.github.io/posts/tech/p10_llvm_analysis_0_formatv/><link crossorigin=anonymous href=/assets/css/stylesheet.a82955faa917eb088598a3f91ac57597187a910fe8499e3b1c922d4f9cbe56b2.css integrity="sha256-qClV+qkX6wiFmKP5GsV1lxh6kQ/oSZ47HJItT5y+VrI=" rel="preload stylesheet" as=style><link rel=icon href=https://canftin.github.io/img/text_icon.ico><link rel=icon type=image/png sizes=16x16 href=https://canftin.github.io/img/text_icon.ico><link rel=icon type=image/png sizes=32x32 href=https://canftin.github.io/img/text_icon.ico><link rel=apple-touch-icon href=https://canftin.github.io/text_icon.ico><link rel=mask-icon href=https://canftin.github.io/text_icon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="LLVM源码分析系列(0): formatv"><meta property="og:description" content="这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后"><meta property="og:type" content="article"><meta property="og:url" content="https://canftin.github.io/posts/tech/p10_llvm_analysis_0_formatv/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-10T16:03:07+08:00"><meta property="article:modified_time" content="2023-10-10T16:03:07+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="LLVM源码分析系列(0): formatv"><meta name=twitter:description content="这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://canftin.github.io/posts/"},{"@type":"ListItem","position":2,"name":"技术","item":"https://canftin.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"LLVM源码分析系列(0): formatv","item":"https://canftin.github.io/posts/tech/p10_llvm_analysis_0_formatv/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LLVM源码分析系列(0): formatv","name":"LLVM源码分析系列(0): formatv","description":"这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后","keywords":[""],"articleBody":"这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后续慢慢剖析LLVM中的实现。\n1. 关于代码格式化 在讲这篇文章之前，首先要讲讲 format 到底是什么，在不同的语言中以及不同的库中，它的输出形式是什么样子，如何对程序员友好的输出 format，以及关于它的性能。\n1.1 什么是 format 在大多数现代语言中都提供了基本的 format 即格式化操作，在 Rust 中，格式化字符串和其他数据主要通过 std::fmt 模块和 println! 宏实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 struct Point { x: i32, y: i32, } impl std::fmt::Display for Point { fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter) -\u003e std::fmt::Result { write!(f, \"({}, {})\", self.x, self.y) } } let point = Point { x: 5, y: 10 }; println!(\"{}\", point); // 输出: (5, 10) 以上，std::fmt::Formatter 类型提供了一系列方法和选项，为用户友好的输出格式化类型。std::fmt 提供的功能允许用户以各种方式格式化和显示数据，使 Rust 代码更具可读性。\n1 2 3 4 5 6 7 8 9 10 11 let name = \"world\"; let message = format!(\"Hello, {}!\", name); let num = 15; let x = 10; let ref_to_x = \u0026x; println!(\"{}\", message); println!(\"{:b}\", num); // 输出二进制: 1111 println!(\"{:o}\", num); // 输出八进制: 17 println!(\"{:x}\", num); // 输出小写十六进制: f println!(\"{:p}\", ref_to_x); // 输出 x 的引用的内存地址 println!(\"{:e}\", num); // 输出小写的科学记数法 Rust 的 format! 宏提供了类型安全的字符串格式化。这意味着编译时会检查格式字符串与给定参数是否匹配，有助于避免许多常见的运行时错误。\nGo 的 fmt 包提供了格式化 I/O 功能，其中包括了各种函数如 Println(), Printf(), Sprint() 等。\n1 2 3 4 5 6 7 import \"fmt\" func main() { name := \"world\" message := fmt.Sprintf(\"Hello, %s!\", name) fmt.Println(message) } Sprintf 用于格式化并返回一个字符串。Go 的格式化是反射驱动的，为多种类型提供了强大的格式化选项。\n在 C# 中，字符串格式化的主要方式是 string.Format() 方法和 $ 字符串插值（从 C# 6 开始）。\n1 2 3 4 5 6 7 8 9 using System; public class HelloWorld { public static void Main() { string name = \"world\"; string message = String.Format(\"Hello, {0}!\", name); Console.WriteLine(message); } } String.Format 方法提供了一个格式化字符串和参数列表，并返回格式化后的字符串。该方法在运行时检查格式与参数是否匹配，并提供了各种格式化选项，例如日期、货币和自定义格式化。\nPython 提供了多种字符串格式化方法，如 % 格式化、str.format() 和 f-strings。f-strings 是 Python 3.6 之后引入的，提供了简洁的内嵌表达式插值。\n1 2 3 name = \"world\" message = \"Hello, {}!\".format(name) print(message) 或使用 f-string (Python 3.6+):\n1 2 3 name = \"world\" message = f\"Hello, {name}!\" print(message) 而在 C++ 中，C++ 的标准输出流（如 std::cout、std::cerr）与流操作符（如 \u003c\u003c）结合使用，提供了一种顺序、连续的方式来输出数据。\n通过流操作符可以轻松地链式输出各种数据类型。但是格式化能力相对有限。例如，设置字段宽度、填充字符和精度通常需要先设置特定的 I/O 操作符或成员函数。\nC++20 已经引入了 std::format，基于github上的 fmtlib 库，format 提供了一种更加灵活、描述性强、类型安全的格式化字符串的方法，能够使用更丰富的格式选项来构造字符串。例如：\n1 std::string message = std::format(\"Hello, {}!\", \"world\"); 以上介绍了几种不同语言中的format，总而言之，各种语言中的 format 功能都是为了使字符串格式化变得更加简单、安全和强大。\n1.2 LLVM 的 formatv 字符串格式化 LLVM 虽然不经常进行大量的字符串操作和解析，但进行了大量的字符串格式化。从诊断信息、到 LLVM 工具的输出，例如 llvm-readobj，再到打印详细的反汇编列表和 LLDB 运行时日志，都需要字符串格式化。\nformatv 在使用上类似于 printf，但使用了不同的语法，该语法主要受到 Python 和 C# 的影响。但不同于 printf，它在编译时推断要格式化的类型，因此不需要像 %d 这样的格式说明符。这减少了尝试构造可移植格式字符串的心智负担，特别是对于平台特定类型，如 size_t 或指针类型。与 printf 和 Python 都不同，如果 LLVM 不知道如何格式化该类型，它还会失败并不编译。以上这两个属性确保该函数比传统的格式化方法（如 printf 函数族）更安全、更简单。\n使用 llvm format 的方式：\n调用 formatv 包括一个由 0 个或多个替换序列组成的格式字符串，后跟一个可变长度的替换值列表。 替换序列是 {N[[,align]:style]} 形式的字符串。 N 是替换值列表中的参数的 0 为索引。这意味着可以多次、可能使用不同的样式和/或对齐选项、以任何顺序引用相同的参数。 自定义格式化：\n有两种方法可以自定义类型的格式化行为。\n为类型 T 提供 llvm::format_provider 的模板特化，以及相应的静态格式化方法。 1 2 3 4 5 6 7 8 9 10 11 12 namespace llvm { template\u003c\u003e struct format_provider\u003cMyFooBar\u003e { static void format(const MyFooBar \u0026V, raw_ostream \u0026Stream, StringRef Style) { // Do whatever is necessary to format `V` into `Stream` } }; void foo() { MyFooBar X; std::string S = formatv(\"{0}\", X); } } 这是一种有用的扩展性机制，用于为用户自定义类型添加支持自定义选项的格式化。但当想要扩展已知如何格式化的类型的机制时，则需要其他方法。\n提供从 llvm::FormatAdapter 继承的格式化适配器。 1 2 3 4 5 6 7 8 9 10 11 12 13 namespace anything { struct format_int_custom : public llvm::FormatAdapter\u003cint\u003e { explicit format_int_custom(int N) : llvm::FormatAdapter\u003cint\u003e(N) {} void format(llvm::raw_ostream \u0026Stream, StringRef Style) override { // Do whatever is necessary to format ``this-\u003eItem`` into ``Stream`` } }; } namespace llvm { void foo() { std::string S = formatv(\"{0}\", anything::format_int_custom(42)); } } 如果检测到类型是从 FormatAdapter 派生出来的，formatv 将在传入指定样式的参数上调用格式化方法。这允许为任何类型提供自定义格式化，包括已经具有内置格式化提供程序的类型。\nformatv 示例：\n以下提供了一组示例，演示了 formatv 的用法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 std::string S; // 对基本类型和隐式字符串转换的简单格式化。 S = formatv(\"{0} ({1:P})\", 7, 0.35); // S == \"7 (35.00%)\" // 乱序引用和多重引用 outs() \u003c\u003c formatv(\"{0} {2} {1} {0}\", 1, \"test\", 3); // 输出 \"1 3 test 1\" // 左、右和中心对齐 S = formatv(\"{0,7}\", 'a'); // S == \" a\"; S = formatv(\"{0,-7}\", 'a'); // S == \"a \"; S = formatv(\"{0,=7}\", 'a'); // S == \" a \"; S = formatv(\"{0,+7}\", 'a'); // S == \" a\"; // 自定义样式 S = formatv(\"{0:N} - {0:x} - {1:E}\", 12345, 123908342); // S == \"12,345 - 0x3039 - 1.24E8\" // 适配器 S = formatv(\"{0}\", fmt_align(42, AlignStyle::Center, 7)); // S == \" 42 \" S = formatv(\"{0}\", fmt_repeat(\"hi\", 3)); // S == \"hihihi\" S = formatv(\"{0}\", fmt_pad(\"hi\", 2, 6)); // S == \" hi \" // 范围 std::vector\u003cint\u003e V = {8, 9, 10}; S = formatv(\"{0}\", make_range(V.begin(), V.end())); // S == \"8, 9, 10\" S = formatv(\"{0:$[+]}\", make_range(V.begin(), V.end())); // S == \"8+9+10\" S = formatv(\"{0:$[ + ]@[x]}\", make_range(V.begin(), V.end())); // S == \"0x8 + 0x9 + 0xA\" 这些示例展示了 formatv 的使用方式，可用于灵活和类型安全地格式化字符串。\nformatv 示例：\n1 2 3 4 std::string S; S = formatv(\"{0} ({1:P})\", 7, 0.35); // S == \"7 (35.00%)\" // ... (其他示例) S = formatv(\"{0:$[ + ]@[x]}\", make_range(V.begin(), V.end())); // S == \"0x8 + 0x9 + 0xA\" llvm formatv 对比 printf 的好处：\n比传统的 printf 更安全、简单。 类型安全，防止格式化错误。 更易于构造可移植的格式字符串。 llvm formatv 与 fmtlib 的不同：\nformatv 有着与 Python 和 C# 类似的格式化语法，而 fmtlib 的语法受到 Python 的 str.format() 的影响。 formatv 在编译时推断格式化类型，而 fmtlib 也提供了相似的类型安全特性。 formatv 的扩展性可能与 fmtlib 有所不同，因为它们采用了不同的方法来实现自定义格式化。 总的来说，formatv 提供了一个强大而类型安全的方式来格式化字符串，并具有与其他格式化方法不同的特性和优点。\n2. formatv的极简实现 以下我提供一个简单的format实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 template \u003ctypename... Args\u003e auto Format(const char* formatter, const Args\u0026... args) -\u003e std::string; template \u003ctypename... Args\u003e auto Format(const std::string\u0026 formatter, const Args\u0026... args) -\u003e std::string; template \u003ctypename... Args\u003e auto PrintFormatted(const char* formatter, const Args\u0026... args) -\u003e void; template \u003ctypename... Args\u003e auto PrintFormatted(const std::string\u0026 formatter, const Args\u0026... args) -\u003e void; inline auto IsDigit(char c) -\u003e bool { return c \u003e= '0' \u0026\u0026 c \u003c= '9'; } inline auto Consume(const char*\u0026 s) -\u003e char { assert(*s); return *(s++); } inline auto ConsumeIf(const char*\u0026 s, char c) -\u003e bool { assert(c != '\\0'); if (*s == c) { ++s; return true; } return false; } class FormatError : public std::runtime_error { public: explicit FormatError(const std::string\u0026 msg) : std::runtime_error(msg) {} }; inline void FormatAssert(bool pred, std::string msg = \"Unknown format error.\") { if (!pred) { throw FormatError(msg); } } template \u003ctypename Stream, typename... Args\u003e auto FormatImpl(Stream\u0026 output, const std::string\u0026 formatter, const Args\u0026... args) -\u003e void { static_assert(sizeof...(args) \u003c 11, \"Only support 10 args.\"); if (formatter.empty()) { return; } constexpr auto ArgsCount = sizeof...(args); std::function\u003cvoid(Stream\u0026)\u003e helpers[10] = {[\u0026](auto\u0026 ss) { ss \u003c\u003c args; }...}; size_t next_id = 0; for (const auto* p = formatter.c_str(); *p;) { if (ConsumeIf(p, '{')) { if (ConsumeIf(p, '{')) { output.put('{'); } else { size_t id; if (ConsumeIf(p, '}')) { id = next_id++; } else { assert(IsDigit(*p)); id = Consume(p) - '0'; FormatAssert(id \u003e= 0 \u0026\u0026 id \u003c= 9, \"Argument id must be within [0,10).\"); FormatAssert(id \u003c ArgsCount, \"Not enough arguments.\"); FormatAssert(ConsumeIf(p, '}'), \"Invalid argument reference.\"); } helpers[id](output); } } else if (ConsumeIf(p, '}')) { if (ConsumeIf(p, '}')) { output.put('}'); } else { FormatAssert(false, \"An isolated closing brace is not allowed.\"); } } else { output.put(Consume(p)); } } } template \u003ctypename... Args\u003e auto Format(const char* formatter, const Args\u0026... args) -\u003e std::string { std::stringstream ss; FormatImpl(ss, formatter, args...); return ss.str(); } template \u003ctypename... Args\u003e auto PrintFormatted(const char* formatter, const Args\u0026... args) -\u003e void { FormatImpl(std::cout, formatter, args...); } 这段代码实现了一种类似于字符串格式化的机制，它允许使用占位符来动态替换字符串中的值。该机制包括两个主要函数模板：Format 和 PrintFormatted，以及相关的辅助函数。\n逐步详细分析这段代码：\n2.1 辅助函数 FormatAssert FormatAssert 是一个辅助函数，用于在断言失败时抛出 FormatError 异常。这个函数的目的是确保断言的条件为真，如果条件为假，就会抛出异常。用于检查格式字符串的有效性和参数的合法性。\n2.2 函数模板 FormatImpl FormatImpl 是一个模板函数，接受一个输出流（通常是 std::stringstream 或 std::cout）以及一个格式字符串和一系列参数。它的主要任务是解析格式字符串并根据参数的数量和格式进行替换，然后将结果输出到给定的输出流。\n函数内部的关键部分是解析格式字符串的循环。它遍历格式字符串的每个字符，根据字符的不同来执行不同的操作：\n如果遇到双花括号 {{，则输出一个单独的花括号 {。 如果遇到花括号 {，则开始解析占位符。 占位符中可以包含占位符索引，例如 {0}、{1}，或者可以省略，例如 {}。 解析占位符时，首先检查是否有索引，如果没有则使用下一个可用索引。 然后根据索引查找对应的参数，并使用参数的类型的 \u003c\u003c 操作符将参数添加到输出流中。 如果占位符不是合法的格式，例如 {10}，或者没有正确的闭合括号，将会抛出异常。 2.3 函数模板 Format 和 PrintFormatted 这两个函数是对 FormatImpl 函数的封装，使其更加方便地使用。\nFormat 函数接受一个格式字符串和一系列参数，然后创建一个 std::stringstream 对象，在其中使用 FormatImpl 将格式化后的字符串放入流中，并返回最终的格式化结果作为一个字符串。 PrintFormatted 函数接受一个格式字符串和一系列参数，然后直接使用 FormatImpl 将格式化后的内容输出到标准输出流 std::cout。 这两个函数使得使用格式化字符串更加方便。\n2.4 测试使用 1 2 3 4 5 std::string yield = Format(\"a({},{},{},{})\", 1, 2.2, '3', \"\\\"4\\\"\"); std::string yield = Format(\"{{{0}}}\", \"text\"); std::string yield = Format(\"{{{0}, {2}\", \"foo\", \"bar\", \"baz\"); std::string yield = Format(\"test-{2}{1}{0}\", 11, 22, 33); std::string yield = Format(\"{}{}{0}!!\", 11, 22); 这个简易实现代码的问题在于它只能接受10个 id，只是在字符串语法层面完成了基础的功能，接下来我们看一下llvm format的实现。\n3. LLVM formatv源码分析 LLVM formatv使用了LLVM Support 和 ADT 库做支持。这里我提供抽离出 LLVM format 组件后的仓库：https://github.com/CanftIn/formatv，这个修改后的format库仅依赖于标准库，便于我们进行代码分析。\n3.1 FormatVariadicDetails 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 // 这是一个模板结构，充当自定义的格式提供者。 // 用户应该为特定的类型特化这个模板以提供格式化功能。 template \u003ctypename T, typename Enable = void\u003e struct FormatProvider {}; namespace Internal { // 它是一个抽象基类，定义了一个纯虚函数format。所有适配器类都需要继承这个基类并实现这个函数。 class FormatAdapter { public: virtual void format(std::ostream\u0026 os, std::string options) = 0; protected: virtual ~FormatAdapter() = default; private: virtual void anchor() {} }; // ProviderFormatAdapter 和 StreamOperatorFormatAdapter 类: // 这两个类都是FormatAdapter的具体子类。 // // ProviderFormatAdapter使用FormatProvider为特定类型进行格式化， // 而StreamOperatorFormatAdapter则使用流插入运算符(\u003c\u003c)为类型进行格式化。 template \u003ctypename T\u003e class ProviderFormatAdapter : public FormatAdapter { public: explicit ProviderFormatAdapter(T\u0026\u0026 item) : item_(std::forward\u003cT\u003e(item)) {} void format(std::ostream\u0026 os, std::string options) override { FormatProvider\u003cstd::decay_t\u003cT\u003e\u003e::format(item_, os, options); } private: T item_; }; template \u003ctypename T\u003e class StreamOperatorFormatAdapter : public FormatAdapter { public: explicit StreamOperatorFormatAdapter(T\u0026\u0026 item) : item_(std::forward\u003cT\u003e(item)) {} void format(std::ostream\u0026 os, std::string /*options*/) override { os \u003c\u003c item_; } private: T item_; }; template \u003ctypename T\u003e class MissingFormatAdapter; template \u003ctypename T, T\u003e struct SameType; // HasFormatProvider 和 HasStreamOperator 类: // 这两个模板结构用于检查一个给定的类型是否有与FormatProvider或流插入运算符相关的格式化功能。 // FormatProvider should have the signature: // static void format(const T\u0026, raw_stream \u0026, StringRef); template \u003cclass T\u003e class HasFormatProvider { public: using Decayed = std::decay_t\u003cT\u003e; using SignatureFormat = void (*)(const Decayed\u0026, std::ostream\u0026, std::string); template \u003ctypename U\u003e static auto test(SameType\u003cSignatureFormat, \u0026U::format\u003e*) -\u003e char; template \u003ctypename U\u003e static auto test(...) -\u003e double; static constexpr bool const Value = (sizeof(test\u003cFormatProvider\u003cDecayed\u003e\u003e(nullptr)) == 1); }; template \u003cclass T\u003e class HasStreamOperator { public: using ConstRefT = const std::decay_t\u003cT\u003e\u0026; template \u003ctypename U\u003e static auto test( std::enable_if_t\u003cstd::is_same_v\u003cdecltype(std::declval\u003cstd::ostream\u0026\u003e() \u003c\u003c std::declval\u003cU\u003e()), std::ostream\u0026\u003e, int*\u003e) -\u003e char; template \u003ctypename U\u003e static auto test(...) -\u003e double; static constexpr bool const Value = (sizeof(test\u003cConstRefT\u003e(nullptr)) == 1); }; // Uses* 结构: // 这些结构根据上面的检查，决定哪种适配器应该用于给定的类型。 template \u003ctypename T\u003e struct UsesFormatMember : public std::integral_constant\u003c bool, std::is_base_of_v\u003cFormatAdapter, std::remove_reference_t\u003cT\u003e\u003e\u003e { }; template \u003ctypename T\u003e struct UsesFormatProvider : public std::integral_constant\u003cbool, !UsesFormatMember\u003cT\u003e::value \u0026\u0026 HasFormatProvider\u003cT\u003e::Value\u003e {}; template \u003ctypename T\u003e struct UsesStreamOperator : public std::integral_constant\u003cbool, !UsesFormatMember\u003cT\u003e::value \u0026\u0026 !UsesFormatProvider\u003cT\u003e::value \u0026\u0026 HasStreamOperator\u003cT\u003e::Value\u003e {}; template \u003ctypename T\u003e struct UsesMissingProvider : public std::integral_constant\u003cbool, !UsesFormatMember\u003cT\u003e::value \u0026\u0026 !UsesFormatProvider\u003cT\u003e::value \u0026\u0026 !HasStreamOperator\u003cT\u003e::Value\u003e {}; // build_format_adapter 函数模板: // 这是一个函数模板的重载集合，根据对象的类型选择合适的格式适配器， // 并将对象传递给适配器进行格式化。它使用SFINAE来选择适当的重载版本， // 根据对象是否满足不同的格式化要求。 template \u003ctypename T\u003e auto build_format_adapter(T\u0026\u0026 item) -\u003e std::enable_if_t\u003cUsesFormatMember\u003cT\u003e::value, T\u003e { return std::forward\u003cT\u003e(item); } template \u003ctypename T\u003e auto build_format_adapter(T\u0026\u0026 item) -\u003e std::enable_if_t\u003cUsesFormatProvider\u003cT\u003e::value, ProviderFormatAdapter\u003cT\u003e\u003e { return ProviderFormatAdapter\u003cT\u003e(std::forward\u003cT\u003e(item)); } template \u003ctypename T\u003e auto build_format_adapter(T\u0026\u0026 item) -\u003e std::enable_if_t\u003cUsesStreamOperator\u003cT\u003e::value, StreamOperatorFormatAdapter\u003cT\u003e\u003e { return StreamOperatorFormatAdapter\u003cT\u003e(std::forward\u003cT\u003e(item)); } template \u003ctypename T\u003e auto build_format_adapter(T\u0026\u0026 item) -\u003e std::enable_if_t\u003cUsesMissingProvider\u003cT\u003e::value, MissingFormatAdapter\u003cT\u003e\u003e { return MissingFormatAdapter\u003cT\u003e(std::forward\u003cT\u003e(item)); } } // namespace Internal 这里先简单讲一下上面用到的适配器模式。\n1. 适配器模式简单示例：\n假设我们有一个旧的系统，其中有一个 OldPrinter 类可以打印简单的文本消息。现在我们想要一个新的打印机类 NewPrinter，它可以打印富文本。但我们不想改变旧代码。我们可以使用适配器模式来实现这一目标。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // 旧的打印机 class OldPrinter { public: void printSimpleMessage(const std::string\u0026 msg) { std::cout \u003c\u003c msg \u003c\u003c std::endl; } }; // 新的打印机 class NewPrinter { public: void printRichMessage(const std::string\u0026 msg) { // 假设这里有一些富文本处理 std::cout \u003c\u003c \"\" \u003c\u003c msg \u003c\u003c \"\" \u003c\u003c std::endl; } }; // 适配器 class PrinterAdapter : public OldPrinter { NewPrinter newPrinter; public: void printSimpleMessage(const std::string\u0026 msg) override { newPrinter.printRichMessage(msg); } }; int main() { PrinterAdapter adaptedPrinter; adaptedPrinter.printSimpleMessage(\"Hello, Adapter Pattern!\"); return 0; } 输出：\n1 \u003crich\u003eHello, Adapter Pattern!\u003c/rich\u003e 2. 大型项目实际使用的代码例子：\n在大型项目中，数据库迁移是一个常见的场景。假设我们的项目最初使用 SQLite，但现在想迁移到 PostgreSQL。这两个数据库在某些查询语法上可能有所不同。我们可以使用适配器模式来确保代码的一致性。\n首先，定义一个数据库接口：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 class Database { public: virtual void connect() = 0; virtual void query(const std::string\u0026 q) = 0; }; class SQLite : public Database { // 实现SQLite的具体逻辑 }; class PostgreSQL : public Database { // 实现PostgreSQL的具体逻辑 }; class DatabaseAdapter : public SQLite { PostgreSQL pg; public: void connect() override { pg.connect(); } void query(const std::string\u0026 q) override { // 可能需要将SQLite的查询语法转换为PostgreSQL的查询语法 pg.query(convertQuery(q)); } std::string convertQuery(const std::string\u0026 q) { // 实现转换逻辑 return q; } }; 在上面提供的 format 代码部分中，适配器模式的使用有其特定的优点：\n统一格式化接口： 虽然不同的数据类型可能有不同的格式化需求和实现，但使用适配器模式可以为所有这些类型提供统一的格式化接口。这意味着无论数据类型的内部如何，调用代码只需知道如何与FormatAdapter接口交互。\n解耦： 适配器模式允许将数据类型的具体格式化逻辑从其使用方式中分离出来。这意味着，如果某个类型的格式化逻辑需要更改，那么只需要更改相应的适配器或 FormatProvider，而不需要更改调用格式化功能的其他部分。\n灵活性： 使用适配器模式，可以轻松地为不支持默认格式化（例如流运算符）的类型提供自定义的格式化方法。\n扩展性： 如果在未来需要添加对新的数据类型或格式化方法的支持，只需添加新的 FormatProvider 或适配器，而无需修改现有的调用代码。\n可维护性： 由于格式化逻辑与其使用方式分离，因此更容易维护。对一个类型的格式化逻辑的更改不会影响其他类型或调用代码。\n降低复杂性： 通过提供一个统一的接口和几个适配器，可以将复杂的格式化决策和逻辑隐藏在适配器模式的实现中，从而降低客户端代码的复杂性。\n更好的代码组织： 有了明确的结构和分离的职责，代码组织得更加清晰。每个适配器或 FormatProvider 都有其明确的目的，使得开发人员更容易理解和跟踪代码的工作方式。\n总的来说，适配器模式提供了一种灵活、扩展性强并且易于维护的方法，来处理可能存在的不同的格式化需求。\n3.2 FormatAlign 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 enum class AlignStyle : uint8_t { Left, // \"-\" Center, // \"=\" Right, // \"+\" }; struct FormatAlign { Internal::FormatAdapter\u0026 adapter_; // 引用要格式化并对齐的FormatAdapter。 AlignStyle where_; // 一个指示如何对齐输出的AlignStyle枚举值。 size_t amount_; // 指示总共需要多少字符宽度的大小。 char fill_; // 当输出的文本不足指定的字符宽度时，用来填充的字符，默认为空格。 FormatAlign(Internal::FormatAdapter\u0026 adapter, AlignStyle where, size_t amount, char fill = ' ') : adapter_(adapter), where_(where), amount_(amount), fill_(fill) {} void format(std::ostream\u0026 os, std::string options) { if (amount_ == 0) { adapter_.format(os, options); return; } std::ostringstream stream; adapter_.format(stream, options); std::string item = stream.str(); if (amount_ \u003c= item.size()) { os \u003c\u003c item; return; } size_t pad_amount = amount_ - item.size(); switch (where_) { case AlignStyle::Left: os \u003c\u003c item; fill(os, pad_amount); break; case AlignStyle::Center: { size_t x = pad_amount / 2; fill(os, x); os \u003c\u003c item; fill(os, pad_amount - x); break; } default: fill(os, pad_amount); os \u003c\u003c item; break; } } private: void fill(std::ostream\u0026 os, uint32_t count) { for (uint32_t i = 0; i \u003c count; ++i) { os \u003c\u003c fill_; } } }; 这段代码定义了一个关于文本对齐的功能。它能够对 FormatAdapter 的输出进行对齐。\nAlignStyle 枚举类：\n这是一个指示对齐方式的枚举。有三种对齐方式：左对齐、居中和右对齐，它们被标记为 “-”, “=” 和 “+\"。 FormatAlign 结构体：\n这个结构体的目的是对一个给定的 FormatAdapter 的输出进行对齐。\nformat 方法是这个结构体的核心，它的目的是首先使用 adapter_ 来获取要对齐的字符串，并将其对齐到指定的宽度 amount_。具体的对齐方式取决于 where_ 成员的值。\nfill 是一个私有的辅助函数，用于在 std::ostream 中插入指定数量的 fill_ 字符。\n此部分代码允许用户指定文本的对齐方式和宽度，并选择填充字符。例如，用户可能希望将数字对齐到右侧，使用空格作为填充字符，以使所有数字都能在相同的宽度内对齐。\n假设有一个可以使用 FormatAdapter 接口的数字，并且将这个数字格式化为10个字符宽，并将其居中对齐，使用 ‘.’ 作为填充字符：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #include int main() { std::ostringstream num_stream; num_stream \u003c\u003c 12345; Internal::FormatAdapter adapter; FormatAlign align(adapter, AlignStyle::Center, 10, '.'); std::ostringstream final_stream; align.format(final_stream, \"\"); std::cout \u003c\u003c final_stream.str() \u003c\u003c std::endl; // 输出: \"...12345...\" return 0; } 3.3 FormatVariadic 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 // 格式化字符串中的替换操作类型。 enum class ReplacementType : uint8_t { Empty, // 表示没有替换。 Format, // 表示应该格式化和替换的项目。 Literal, // 表示应原样插入的字符串字面量。 }; // 保存每个替换项的格式说明详情。 struct ReplacementItem { ReplacementItem() = default; explicit ReplacementItem(std::string literal) : type(ReplacementType::Literal), spec(std::move(literal)) {} ReplacementItem(std::string spec, size_t index, size_t align, AlignStyle where, char pad, std::string options) : type(ReplacementType::Format), spec(std::move(spec)), index(index), align(align), where(where), pad(pad), options(std::move(options)) {} // 替换的类型。 ReplacementType type = ReplacementType::Empty; // 来自格式的原始字符串。 std::string spec; // 要替换的值的索引。 size_t index = 0; // align, where, pad: 对齐的规格说明。 size_t align = 0; // 对齐大小。 AlignStyle where = AlignStyle::Right; // 对齐样式。 char pad = 0; // 填充字符。 // 替换项的其他格式选项。 std::string options; }; class FormatvObjectBase; auto operator\u003c\u003c(std::ostream\u0026 os, const FormatvObjectBase\u0026 obj) -\u003e std::ostream\u0026; // 用于格式化对象的基类。 class FormatvObjectBase { public: FormatvObjectBase(const FormatvObjectBase\u0026) = delete; auto operator=(const FormatvObjectBase\u0026) -\u003e FormatvObjectBase\u0026 = delete; // 根据替换项格式化字符串并将其写入给定的ostream。 void format(std::ostream\u0026 os) const { for (auto\u0026 r : ParseFormatString(fmt_)) { switch (r.type) { case ReplacementType::Empty: continue; case ReplacementType::Literal: os \u003c\u003c r.spec; continue; case ReplacementType::Format: { if (r.index \u003e= adapters_.size()) { os \u003c\u003c r.spec; continue; } auto* w = adapters_[r.index]; FormatAlign align(*w, r.where, r.align, r.pad); align.format(os, r.options); } default: continue; } } } // 解析格式字符串以获取替换项列表。 static auto ParseFormatString(std::string fmt) -\u003e std::vector\u003cReplacementItem\u003e { std::vector\u003cReplacementItem\u003e replacements; ReplacementItem i; while (!fmt.empty()) { std::tie(i, fmt) = SplitLiteralAndReplacement(fmt); if (i.type != ReplacementType::Empty) { replacements.push_back(i); } } return replacements; } // 将单个替换规格解析为ReplacementItem。 static auto ParseReplacementItem(std::string spec) -\u003e std::optional\u003cReplacementItem\u003e { // 移除 spec 字符串的 { 和 }。 std::string rep_string = FormatUtil::trim(spec, \"{}\"); char pad = ' '; std::size_t align = 0; AlignStyle where = AlignStyle::Right; std::string options; size_t index = 0; // 移除 rep_string 的前后空白字符。 rep_string = FormatUtil::trim(rep_string); // 尝试从 rep_string 开始的位置解析一个整数，并将其赋值给 index。 if (FormatUtil::ConsumeInteger(rep_string, 0, index)) { assert(false \u0026\u0026 \"Invalid replacement sequence index!\"); return ReplacementItem{}; } rep_string = FormatUtil::trim(rep_string); // 第一个字符为 `,`，它将尝试解析字段布局。 // `,`: 通常是用于字段布局或对齐的指示符。 // 例如，`{0,10}`，其中 0 是要替换的参数索引， // 10 是指示字段宽度或对齐的数字。`,` 符号在此处用作分隔符。 if (!rep_string.empty() \u0026\u0026 rep_string.front() == ',') { rep_string = FormatUtil::drop_front(rep_string, 1); if (!ConsumeFieldLayout(rep_string, where, align, pad)) { assert(false \u0026\u0026 \"Invalid replacement field layout specification!\"); } } rep_string = FormatUtil::trim(rep_string); // 第一个字符是否为 `:`，它会从 rep_string 中提取选项字符串。 // `:`: 这通常是用于格式选项的指示符。 // 例如， `{0:0.00}`，其中 0 是要替换的参数索引，0.00 是指示 // 如何格式化数字的选项（例如，始终显示两位小数）。 if (!rep_string.empty() \u0026\u0026 rep_string.front() == ':') { rep_string = FormatUtil::drop_front(rep_string, 1); options = FormatUtil::trim(rep_string); rep_string = \"\"; } rep_string = FormatUtil::trim(rep_string); if (!rep_string.empty()) { assert(false \u0026\u0026 \"Unexpected characters found in replacement string!\"); } return ReplacementItem{spec, index, align, where, pad, options}; } // 返回格式化的字符串。 auto str() const -\u003e std::string { std::ostringstream stream; stream \u003c\u003c *this; std::string result = stream.str(); stream.flush(); return result; } // 将对象转换为字符串。 operator std::string() const { return str(); } protected: FormatvObjectBase(std::string fmt, ArrayRef\u003cInternal::FormatAdapter*\u003e adapters) : fmt_(std::move(fmt)), adapters_(adapters.begin(), adapters.end()) {} FormatvObjectBase(FormatvObjectBase\u0026\u0026) = default; // 解析对齐、填充和宽度规格。 static auto ConsumeFieldLayout(std::string\u0026 spec, AlignStyle\u0026 where, size_t\u0026 align, char\u0026 pad) -\u003e bool { where = AlignStyle::Right; align = 0; pad = ' '; if (spec.empty()) { return true; } if (spec.size() \u003e 1) { if (auto loc = FormatUtil::TranslateLocChar(spec[1])) { pad = spec[0]; where = *loc; spec = FormatUtil::drop_front(spec, 2); } else if (auto loc = FormatUtil::TranslateLocChar(spec[0])) { where = *loc; spec = FormatUtil::drop_front(spec, 1); } } bool failed = FormatUtil::ConsumeInteger(spec, 0, align); return !failed; } // 从输入的 fmt 字符串中分离字面量和替换项。 // 即它寻找 `{...}` 结构中的替换项，并将其与其前面的字面量一起返回。 // 如果找到一个连续的 `{` 或者 `{{`，它将按照适当的逻辑对其进行处理。 static auto SplitLiteralAndReplacement(std::string fmt) -\u003e std::pair\u003cReplacementItem, std::string\u003e { while (!fmt.empty()) { // 处理没有 { 开头的字符串。 if (fmt.front() != '{') { std::size_t bo = FormatUtil::find_first_of(fmt, '{'); return std::make_pair(ReplacementItem{FormatUtil::substr(fmt, 0, bo)}, FormatUtil::substr(fmt, bo)); } // 处理连续的 { 字符。 // 如果找到一个或多个 {，它会尝试获取连续的 { 个数，并将其保存在 braces 中。 std::string braces = FormatUtil::take_while(fmt, [](char c) { return c == '{'; }); // 如果连续的 `{` 个数大于1（即 `{{`），它将其解释为转义字符， // 并只保留其中一半作为字面量返回。剩下的部分被视为后续的字符串。 if (braces.size() \u003e 1) { size_t num_excaped_braces = braces.size() / 2; std::string middle = FormatUtil::take_front(fmt, num_excaped_braces); std::string right = FormatUtil::drop_front(fmt, num_excaped_braces * 2); return std::make_pair(ReplacementItem{middle}, right); } // 查找匹配的 }。 std::size_t bc = FormatUtil::find_first_of(fmt, '}'); if (bc == std::string::npos) { assert(false \u0026\u0026 \"Unterminated brace sequence. Escape with {{ for a literal \" \"brace.\"); return std::make_pair(ReplacementItem{fmt}, std::string()); } // 查找嵌套的 {。 std::size_t bo2 = FormatUtil::find_first_of(fmt, '{', 1); if (bo2 \u003c bc) { return std::make_pair(ReplacementItem{FormatUtil::substr(fmt, 0, bo2)}, FormatUtil::substr(fmt, bo2)); } // 处理格式说明符。 // 在 { 和 } 之间的字符串被视为替换项的格式说明符。 std::string spec = FormatUtil::slice(fmt, 1, bc); std::string right = FormatUtil::substr(fmt, bc + 1); // 调用 ParseReplacementItem 函数来解析这个说明符。 auto ri = ParseReplacementItem(spec); // 解析成功，它返回解析得到的 ReplacementItem 和 } 之后的字符串。 if (ri) { return std::make_pair(*ri, right); } // 上述所有情况都没有返回结果，函数将删除 fmt 中到 bc 位置之前的所有字符，并继续循环。 fmt = FormatUtil::drop_front(fmt, bc + 1); } // 遍历完整个 fmt 字符串仍然没有找到任何替换项，它将返回整个字符串作为字面量。 return std::make_pair(ReplacementItem{fmt}, std::string()); } std::string fmt_; ArrayRef\u003cInternal::FormatAdapter*\u003e adapters_; }; // 允许直接将格式化的结果流式传输到输出流。 inline auto operator\u003c\u003c(std::ostream\u0026 os, const FormatvObjectBase\u0026 obj) -\u003e std::ostream\u0026 { obj.format(os); return os; } // 表示具有特定参数的格式化操作的模板类。 // 它捕获格式字符串和作为元组的格式化值。 // 保存每个参数的格式适配器的指针，这些适配器知道如何格式化该特定类型。 template \u003ctypename Tuple\u003e class FormatvObject : public FormatvObjectBase { public: FormatvObject(std::string fmt, Tuple\u0026\u0026 params) : FormatvObjectBase(fmt, parameter_pointers_), parameters_(std::move(params)), parameter_pointers_(std::apply(CreateAdapters(), parameters_)) {} FormatvObject(const FormatvObject\u0026 rhs) = delete; FormatvObject(FormatvObject\u0026\u0026 rhs) : FormatvObjectBase(std::move(rhs)), parameters_(std::move(rhs.parameters_)) { parameter_pointers_ = std::apply(CreateAdapters(), parameters_); adapters_ = parameter_pointers_; } private: // 创建格式适配器。 struct CreateAdapters { template \u003ctypename... Ts\u003e auto operator()(Ts\u0026... items) -\u003e std::array\u003cInternal::FormatAdapter*, std::tuple_size\u003cTuple\u003e::value\u003e { return {{\u0026items...}}; } }; Tuple parameters_; std::array\u003cInternal::FormatAdapter*, std::tuple_size\u003cTuple\u003e::value\u003e parameter_pointers_; }; /// // 用户创建格式化字符串的主要接口。 /// // Convert to std::string. /// std::string S = formatv(\"{0} {1}\", 1234.412, \"test\").str(); /// /// OS \u003c\u003c formatv(\"{0} {1}\", 1234.412, \"test\"); template \u003ctypename... Ts\u003e inline auto formatv(const char* fmt, Ts\u0026\u0026... vals) -\u003e FormatvObject\u003cdecltype(std::make_tuple( Internal::build_format_adapter(std::forward\u003cTs\u003e(vals))...))\u003e { using ParamTuple = decltype(std::make_tuple( Internal::build_format_adapter(std::forward\u003cTs\u003e(vals))...)); return FormatvObject\u003cParamTuple\u003e( fmt, std::make_tuple( Internal::build_format_adapter(std::forward\u003cTs\u003e(vals))...)); } 单独对 SplitLiteralAndReplacement 函数中多个连续{，只保留其中一半作为字面量返回的原因：\n这种处理方式是为了使得格式化字符串中可以包含字面量的大括号 { 和 }。在许多格式化库中，{ 和 } 用于定义变量替换的位置，但如果你真的想在结果字符串中包含一个 { 或 } 怎么办呢？这时，你就需要一种方法来\"转义\"这些特殊字符，使它们被解释为普通字符。\n为了实现这一目的，这段代码使用了一个简单的规则：连续的两个 { 被解释为一个字面量的 {。同样，连续的两个 } 被解释为一个字面量的 }。\n考虑以下格式化字符串：\n1 \"Hello {{name}}! The braces are: {{ and }}\" 在这个字符串中，{{name}} 是一个变量替换，而连续的 {{ 和 }} 是转义的大括号。当这个格式化字符串被处理时，它应该产生以下输出（假设 name 被替换为 “Alice”）：\n1 \"Hello Alice! The braces are: { and }\" 所以，连续的 {{ 被解释为单个的 {，连续的 }} 被解释为单个的 }，这就是为什么只保留一半的原因。\n3.4 Format Format 接口不做赘述，主要使用 std::snprintf 作为内部输出函数，主体实现方式和 FormatVariadic 类似。\n至此对llvm中format部分的分析结束。\n4. 引用 [1]. https://zh.cppreference.com/w/cpp/header/format\n[2]. https://llvm.org/docs/ProgrammersManual.html#formatting-strings-the-formatv-function\n[3]. https://github.com/CanftIn/formatv\n","wordCount":"9008","inLanguage":"en","datePublished":"2023-10-10T16:03:07+08:00","dateModified":"2023-10-10T16:03:07+08:00","author":[{"@type":"Person","name":"矩木"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://canftin.github.io/posts/tech/p10_llvm_analysis_0_formatv/"},"publisher":{"@type":"Organization","name":"CanftIn's Blog","logo":{"@type":"ImageObject","url":"https://canftin.github.io/img/text_icon.ico"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://canftin.github.io/ accesskey=h title="CanftIn's Blog (Alt + H)">CanftIn's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://canftin.github.io/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://canftin.github.io/ title=主页><span>主页</span></a></li><li><a href=https://canftin.github.io/posts title=文章><span>文章</span></a></li><li><a href=https://canftin.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://canftin.github.io/tags title=标签><span>标签</span></a></li><li><a href=https://canftin.github.io/about title=关于><span>关于</span></a></li></ul></nav></header><main class="main page"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://canftin.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://canftin.github.io/posts/>所有文章</a>&nbsp;»&nbsp;<a href=https://canftin.github.io/posts/tech/>技术</a></div><h1 class=post-title>LLVM源码分析系列(0): formatv</h1><div class=post-meta><span title='2023-10-10 16:03:07 +0800 CST'>2023-10-10</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;矩木<span style=opacity:.8>
<span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e5%85%b3%e4%ba%8e%e4%bb%a3%e7%a0%81%e6%a0%bc%e5%bc%8f%e5%8c%96 aria-label="1. 关于代码格式化">1. 关于代码格式化</a><ul><li><a href=#11-%e4%bb%80%e4%b9%88%e6%98%af-format aria-label="1.1 什么是 format">1.1 什么是 format</a></li><li><a href=#12-llvm-%e7%9a%84-formatv-%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%a0%bc%e5%bc%8f%e5%8c%96 aria-label="1.2 LLVM 的 formatv 字符串格式化">1.2 LLVM 的 <code>formatv</code> 字符串格式化</a></li></ul></li><li><a href=#2-formatv%e7%9a%84%e6%9e%81%e7%ae%80%e5%ae%9e%e7%8e%b0 aria-label="2. formatv的极简实现">2. formatv的极简实现</a><ul><li><a href=#21-%e8%be%85%e5%8a%a9%e5%87%bd%e6%95%b0-formatassert aria-label="2.1 辅助函数 FormatAssert">2.1 辅助函数 <code>FormatAssert</code></a></li><li><a href=#22-%e5%87%bd%e6%95%b0%e6%a8%a1%e6%9d%bf-formatimpl aria-label="2.2 函数模板 FormatImpl">2.2 函数模板 <code>FormatImpl</code></a></li><li><a href=#23-%e5%87%bd%e6%95%b0%e6%a8%a1%e6%9d%bf-format-%e5%92%8c-printformatted aria-label="2.3 函数模板 Format 和 PrintFormatted">2.3 函数模板 <code>Format</code> 和 <code>PrintFormatted</code></a></li><li><a href=#24-%e6%b5%8b%e8%af%95%e4%bd%bf%e7%94%a8 aria-label="2.4 测试使用">2.4 测试使用</a></li></ul></li><li><a href=#3-llvm-formatv%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="3. LLVM formatv源码分析">3. LLVM formatv源码分析</a><ul><li><a href=#31-formatvariadicdetails aria-label="3.1 FormatVariadicDetails">3.1 FormatVariadicDetails</a></li><li><a href=#32-formatalign aria-label="3.2 FormatAlign">3.2 FormatAlign</a></li><li><a href=#33-formatvariadic aria-label="3.3 FormatVariadic">3.3 FormatVariadic</a></li><li><a href=#34-format aria-label="3.4 Format">3.4 Format</a></li></ul></li><li><a href=#4-%e5%bc%95%e7%94%a8 aria-label="4. 引用">4. 引用</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>这篇文章作为LLVM源码分析系列的开篇，初步介绍LLVM中format的相关机制和原理，format在LLVM中较为容易理解，从这里启航，后续慢慢剖析LLVM中的实现。</p><h2 id=1-关于代码格式化>1. 关于代码格式化<a hidden class=anchor aria-hidden=true href=#1-关于代码格式化>#</a></h2><p>在讲这篇文章之前，首先要讲讲 format 到底是什么，在不同的语言中以及不同的库中，它的输出形式是什么样子，如何对程序员友好的输出 format，以及关于它的性能。</p><h3 id=11-什么是-format>1.1 什么是 format<a hidden class=anchor aria-hidden=true href=#11-什么是-format>#</a></h3><p>在大多数现代语言中都提供了基本的 format 即格式化操作，在 Rust 中，格式化字符串和其他数据主要通过 <code>std::fmt</code> 模块和 <code>println!</code> 宏实现。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Point</span> {
</span></span><span style=display:flex><span>    x: <span style=color:#66d9ef>i32</span>,
</span></span><span style=display:flex><span>    y: <span style=color:#66d9ef>i32</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> std::fmt::Display <span style=color:#66d9ef>for</span> Point {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>fmt</span>(<span style=color:#f92672>&amp;</span>self, f: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> std::fmt::Formatter) -&gt; <span style=color:#a6e22e>std</span>::fmt::Result {
</span></span><span style=display:flex><span>        write!(f, <span style=color:#e6db74>&#34;({}, {})&#34;</span>, self.x, self.y)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> point <span style=color:#f92672>=</span> Point { x: <span style=color:#ae81ff>5</span>, y: <span style=color:#ae81ff>10</span> };
</span></span><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, point);  <span style=color:#75715e>// 输出: (5, 10)
</span></span></span></code></pre></td></tr></table></div></div><p>以上，<code>std::fmt::Formatter</code> 类型提供了一系列方法和选项，为用户友好的输出格式化类型。<code>std::fmt</code> 提供的功能允许用户以各种方式格式化和显示数据，使 Rust 代码更具可读性。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;world&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> message <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>!&#34;</span>, name);
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> num <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> ref_to_x <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>x;
</span></span><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, message);
</span></span><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:b}</span><span style=color:#e6db74>&#34;</span>, num);  <span style=color:#75715e>// 输出二进制: 1111
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:o}</span><span style=color:#e6db74>&#34;</span>, num);  <span style=color:#75715e>// 输出八进制: 17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:x}</span><span style=color:#e6db74>&#34;</span>, num);  <span style=color:#75715e>// 输出小写十六进制: f
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:p}</span><span style=color:#e6db74>&#34;</span>, ref_to_x);  <span style=color:#75715e>// 输出 x 的引用的内存地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:e}</span><span style=color:#e6db74>&#34;</span>, num);  <span style=color:#75715e>// 输出小写的科学记数法
</span></span></span></code></pre></td></tr></table></div></div><p>Rust 的 <code>format!</code> 宏提供了类型安全的字符串格式化。这意味着编译时会检查格式字符串与给定参数是否匹配，有助于避免许多常见的运行时错误。</p><p>Go 的 <code>fmt</code> 包提供了格式化 I/O 功能，其中包括了各种函数如 <code>Println()</code>, <code>Printf()</code>, <code>Sprint()</code> 等。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Hello, %s!&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>Sprintf</code> 用于格式化并返回一个字符串。Go 的格式化是反射驱动的，为多种类型提供了强大的格式化选项。</p><p>在 C# 中，字符串格式化的主要方式是 <code>string.Format()</code> 方法和 <code>$</code> 字符串插值（从 C# 6 开始）。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorld</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Main() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> name = <span style=color:#e6db74>&#34;world&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> message = String.Format(<span style=color:#e6db74>&#34;Hello, {0}!&#34;</span>, name);
</span></span><span style=display:flex><span>        Console.WriteLine(message);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>String.Format</code> 方法提供了一个格式化字符串和参数列表，并返回格式化后的字符串。该方法在运行时检查格式与参数是否匹配，并提供了各种格式化选项，例如日期、货币和自定义格式化。</p><p>Python 提供了多种字符串格式化方法，如 <code>%</code> 格式化、<code>str.format()</code> 和 f-strings。f-strings 是 Python 3.6 之后引入的，提供了简洁的内嵌表达式插值。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>!&#34;</span><span style=color:#f92672>.</span>format(name)
</span></span><span style=display:flex><span>print(message)
</span></span></code></pre></td></tr></table></div></div><p>或使用 f-string (Python 3.6+):</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>
</span></span><span style=display:flex><span>print(message)
</span></span></code></pre></td></tr></table></div></div><p>而在 C++ 中，C++ 的标准输出流（如 <code>std::cout</code>、<code>std::cerr</code>）与流操作符（如 <code>&lt;&lt;</code>）结合使用，提供了一种顺序、连续的方式来输出数据。</p><p>通过流操作符可以轻松地链式输出各种数据类型。但是格式化能力相对有限。例如，设置字段宽度、填充字符和精度通常需要先设置特定的 I/O 操作符或成员函数。</p><p>C++20 已经引入了 std::format，基于github上的 <a href=https://github.com/fmtlib/fmt>fmtlib</a> 库，format 提供了一种更加灵活、描述性强、类型安全的格式化字符串的方法，能够使用更丰富的格式选项来构造字符串。例如：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>string message <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>format(<span style=color:#e6db74>&#34;Hello, {}!&#34;</span>, <span style=color:#e6db74>&#34;world&#34;</span>);
</span></span></code></pre></td></tr></table></div></div><p>以上介绍了几种不同语言中的format，总而言之，各种语言中的 <code>format</code> 功能都是为了使字符串格式化变得更加简单、安全和强大。</p><h3 id=12-llvm-的-formatv-字符串格式化>1.2 LLVM 的 <code>formatv</code> 字符串格式化<a hidden class=anchor aria-hidden=true href=#12-llvm-的-formatv-字符串格式化>#</a></h3><p>LLVM 虽然不经常进行大量的字符串操作和解析，但进行了大量的字符串格式化。从诊断信息、到 LLVM 工具的输出，例如 <code>llvm-readobj</code>，再到打印详细的反汇编列表和 LLDB 运行时日志，都需要字符串格式化。</p><p><code>formatv</code> 在使用上类似于 <code>printf</code>，但使用了不同的语法，该语法主要受到 Python 和 C# 的影响。但不同于 <code>printf</code>，它在编译时推断要格式化的类型，因此不需要像 <code>%d</code> 这样的格式说明符。这减少了尝试构造可移植格式字符串的心智负担，特别是对于平台特定类型，如 <code>size_t</code> 或指针类型。与 <code>printf</code> 和 Python 都不同，如果 LLVM 不知道如何格式化该类型，它还会失败并不编译。以上这两个属性确保该函数比传统的格式化方法（如 <code>printf</code> 函数族）更安全、更简单。</p><p><strong>使用 llvm format 的方式：</strong></p><ul><li>调用 <code>formatv</code> 包括一个由 0 个或多个替换序列组成的格式字符串，后跟一个可变长度的替换值列表。</li><li>替换序列是 <code>{N[[,align]:style]}</code> 形式的字符串。</li><li><code>N</code> 是替换值列表中的参数的 0 为索引。这意味着可以多次、可能使用不同的样式和/或对齐选项、以任何顺序引用相同的参数。</li></ul><p><strong>自定义格式化：</strong></p><p>有两种方法可以自定义类型的格式化行为。</p><ol><li>为类型 <code>T</code> 提供 <code>llvm::format_provider&lt;T></code> 的模板特化，以及相应的静态格式化方法。</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>namespace</span> llvm {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>format_provider</span><span style=color:#f92672>&lt;</span>MyFooBar<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(<span style=color:#66d9ef>const</span> MyFooBar <span style=color:#f92672>&amp;</span>V, raw_ostream <span style=color:#f92672>&amp;</span>Stream, StringRef Style) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Do whatever is necessary to format `V` into `Stream`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    MyFooBar X;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, X);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这是一种有用的扩展性机制，用于为用户自定义类型添加支持自定义选项的格式化。但当想要扩展已知如何格式化的类型的机制时，则需要其他方法。</p><ol start=2><li>提供从 <code>llvm::FormatAdapter&lt;T></code> 继承的格式化适配器。</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>namespace</span> anything {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>format_int_custom</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> llvm<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>explicit</span> <span style=color:#a6e22e>format_int_custom</span>(<span style=color:#66d9ef>int</span> N) <span style=color:#f92672>:</span> llvm<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>(N) {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(llvm<span style=color:#f92672>::</span>raw_ostream <span style=color:#f92672>&amp;</span>Stream, StringRef Style) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Do whatever is necessary to format ``this-&gt;Item`` into ``Stream``
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> llvm {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, anything<span style=color:#f92672>::</span>format_int_custom(<span style=color:#ae81ff>42</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>如果检测到类型是从 <code>FormatAdapter&lt;T></code> 派生出来的，<code>formatv</code> 将在传入指定样式的参数上调用格式化方法。这允许为任何类型提供自定义格式化，包括已经具有内置格式化提供程序的类型。</p><p><strong>formatv 示例：</strong></p><p>以下提供了一组示例，演示了 <code>formatv</code> 的用法。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>string S;
</span></span><span style=display:flex><span><span style=color:#75715e>// 对基本类型和隐式字符串转换的简单格式化。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0} ({1:P})&#34;</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>0.35</span>);  <span style=color:#75715e>// S == &#34;7 (35.00%)&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 乱序引用和多重引用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>outs() <span style=color:#f92672>&lt;&lt;</span> formatv(<span style=color:#e6db74>&#34;{0} {2} {1} {0}&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>3</span>); <span style=color:#75715e>// 输出 &#34;1 3 test 1&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 左、右和中心对齐
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0,7}&#34;</span>,  <span style=color:#e6db74>&#39;a&#39;</span>);  <span style=color:#75715e>// S == &#34;      a&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0,-7}&#34;</span>, <span style=color:#e6db74>&#39;a&#39;</span>);  <span style=color:#75715e>// S == &#34;a      &#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0,=7}&#34;</span>, <span style=color:#e6db74>&#39;a&#39;</span>);  <span style=color:#75715e>// S == &#34;   a   &#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0,+7}&#34;</span>, <span style=color:#e6db74>&#39;a&#39;</span>);  <span style=color:#75715e>// S == &#34;      a&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 自定义样式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0:N} - {0:x} - {1:E}&#34;</span>, <span style=color:#ae81ff>12345</span>, <span style=color:#ae81ff>123908342</span>); <span style=color:#75715e>// S == &#34;12,345 - 0x3039 - 1.24E8&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 适配器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, fmt_align(<span style=color:#ae81ff>42</span>, AlignStyle<span style=color:#f92672>::</span>Center, <span style=color:#ae81ff>7</span>));  <span style=color:#75715e>// S == &#34;  42   &#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, fmt_repeat(<span style=color:#e6db74>&#34;hi&#34;</span>, <span style=color:#ae81ff>3</span>)); <span style=color:#75715e>// S == &#34;hihihi&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, fmt_pad(<span style=color:#e6db74>&#34;hi&#34;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>6</span>)); <span style=color:#75715e>// S == &#34;  hi      &#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 范围
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> V <span style=color:#f92672>=</span> {<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>};
</span></span><span style=display:flex><span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0}&#34;</span>, make_range(V.begin(), V.end())); <span style=color:#75715e>// S == &#34;8, 9, 10&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0:$[+]}&#34;</span>, make_range(V.begin(), V.end())); <span style=color:#75715e>// S == &#34;8+9+10&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0:$[ + ]@[x]}&#34;</span>, make_range(V.begin(), V.end())); <span style=color:#75715e>// S == &#34;0x8 + 0x9 + 0xA&#34;
</span></span></span></code></pre></td></tr></table></div></div><p>这些示例展示了 <code>formatv</code> 的使用方式，可用于灵活和类型安全地格式化字符串。</p><p><strong><code>formatv</code> 示例：</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>string S;
</span></span><span style=display:flex><span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0} ({1:P})&#34;</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>0.35</span>);  <span style=color:#75715e>// S == &#34;7 (35.00%)&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ... (其他示例)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>S <span style=color:#f92672>=</span> formatv(<span style=color:#e6db74>&#34;{0:$[ + ]@[x]}&#34;</span>, make_range(V.begin(), V.end())); <span style=color:#75715e>// S == &#34;0x8 + 0x9 + 0xA&#34;
</span></span></span></code></pre></td></tr></table></div></div><p><strong>llvm formatv 对比 printf 的好处：</strong></p><ul><li>比传统的 <code>printf</code> 更安全、简单。</li><li>类型安全，防止格式化错误。</li><li>更易于构造可移植的格式字符串。</li></ul><p><strong>llvm formatv 与 fmtlib 的不同：</strong></p><ul><li><code>formatv</code> 有着与 Python 和 C# 类似的格式化语法，而 <code>fmtlib</code> 的语法受到 Python 的 <code>str.format()</code> 的影响。</li><li><code>formatv</code> 在编译时推断格式化类型，而 <code>fmtlib</code> 也提供了相似的类型安全特性。</li><li><code>formatv</code> 的扩展性可能与 <code>fmtlib</code> 有所不同，因为它们采用了不同的方法来实现自定义格式化。</li></ul><p>总的来说，<code>formatv</code> 提供了一个强大而类型安全的方式来格式化字符串，并具有与其他格式化方法不同的特性和优点。</p><h2 id=2-formatv的极简实现>2. formatv的极简实现<a hidden class=anchor aria-hidden=true href=#2-formatv的极简实现>#</a></h2><p>以下我提供一个简单的format实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> Format(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>string;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> Format(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>string;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> PrintFormatted(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> PrintFormatted(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>IsDigit</span>(<span style=color:#66d9ef>char</span> c) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> c <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#f92672>&amp;&amp;</span> c <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;9&#39;</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>Consume</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*&amp;</span> s) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>char</span> {
</span></span><span style=display:flex><span>  assert(<span style=color:#f92672>*</span>s);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>*</span>(s<span style=color:#f92672>++</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>ConsumeIf</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*&amp;</span> s, <span style=color:#66d9ef>char</span> c) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>  assert(c <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;\0&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>s <span style=color:#f92672>==</span> c) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>++</span>s;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FormatError</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>runtime_error {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>explicit</span> FormatError(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> msg) <span style=color:#f92672>:</span> std<span style=color:#f92672>::</span>runtime_error(msg) {}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>FormatAssert</span>(<span style=color:#66d9ef>bool</span> pred, std<span style=color:#f92672>::</span>string msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Unknown format error.&#34;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>pred) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> FormatError(msg);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> Stream, <span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> FormatImpl(Stream<span style=color:#f92672>&amp;</span> output, <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> formatter,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static_assert</span>(<span style=color:#66d9ef>sizeof</span>...(args) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>11</span>, <span style=color:#e6db74>&#34;Only support 10 args.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (formatter.empty()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>auto</span> ArgsCount <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>...(args);
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>function<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span>(Stream<span style=color:#f92672>&amp;</span>)<span style=color:#f92672>&gt;</span> helpers[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> {[<span style=color:#f92672>&amp;</span>](<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> ss) { ss <span style=color:#f92672>&lt;&lt;</span> args; }...};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  size_t next_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>auto</span><span style=color:#f92672>*</span> p <span style=color:#f92672>=</span> formatter.c_str(); <span style=color:#f92672>*</span>p;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ConsumeIf(p, <span style=color:#e6db74>&#39;{&#39;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (ConsumeIf(p, <span style=color:#e6db74>&#39;{&#39;</span>)) {
</span></span><span style=display:flex><span>        output.put(<span style=color:#e6db74>&#39;{&#39;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        size_t id;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ConsumeIf(p, <span style=color:#e6db74>&#39;}&#39;</span>)) {
</span></span><span style=display:flex><span>          id <span style=color:#f92672>=</span> next_id<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          assert(IsDigit(<span style=color:#f92672>*</span>p));
</span></span><span style=display:flex><span>          id <span style=color:#f92672>=</span> Consume(p) <span style=color:#f92672>-</span> <span style=color:#e6db74>&#39;0&#39;</span>;
</span></span><span style=display:flex><span>          FormatAssert(id <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> id <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>9</span>,
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#34;Argument id must be within [0,10).&#34;</span>);
</span></span><span style=display:flex><span>          FormatAssert(id <span style=color:#f92672>&lt;</span> ArgsCount, <span style=color:#e6db74>&#34;Not enough arguments.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          FormatAssert(ConsumeIf(p, <span style=color:#e6db74>&#39;}&#39;</span>), <span style=color:#e6db74>&#34;Invalid argument reference.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        helpers[id](output);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (ConsumeIf(p, <span style=color:#e6db74>&#39;}&#39;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (ConsumeIf(p, <span style=color:#e6db74>&#39;}&#39;</span>)) {
</span></span><span style=display:flex><span>        output.put(<span style=color:#e6db74>&#39;}&#39;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        FormatAssert(false, <span style=color:#e6db74>&#34;An isolated closing brace is not allowed.&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      output.put(Consume(p));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> Format(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>string {
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>stringstream ss;
</span></span><span style=display:flex><span>  FormatImpl(ss, formatter, args...);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ss.str();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Args<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> PrintFormatted(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> formatter, <span style=color:#66d9ef>const</span> Args<span style=color:#f92672>&amp;</span>... args) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>  FormatImpl(std<span style=color:#f92672>::</span>cout, formatter, args...);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这段代码实现了一种类似于字符串格式化的机制，它允许使用占位符来动态替换字符串中的值。该机制包括两个主要函数模板：<code>Format</code> 和 <code>PrintFormatted</code>，以及相关的辅助函数。</p><p>逐步详细分析这段代码：</p><h3 id=21-辅助函数-formatassert>2.1 辅助函数 <code>FormatAssert</code><a hidden class=anchor aria-hidden=true href=#21-辅助函数-formatassert>#</a></h3><p><code>FormatAssert</code> 是一个辅助函数，用于在断言失败时抛出 <code>FormatError</code> 异常。这个函数的目的是确保断言的条件为真，如果条件为假，就会抛出异常。用于检查格式字符串的有效性和参数的合法性。</p><h3 id=22-函数模板-formatimpl>2.2 函数模板 <code>FormatImpl</code><a hidden class=anchor aria-hidden=true href=#22-函数模板-formatimpl>#</a></h3><p><code>FormatImpl</code> 是一个模板函数，接受一个输出流（通常是 <code>std::stringstream</code> 或 <code>std::cout</code>）以及一个格式字符串和一系列参数。它的主要任务是解析格式字符串并根据参数的数量和格式进行替换，然后将结果输出到给定的输出流。</p><p>函数内部的关键部分是解析格式字符串的循环。它遍历格式字符串的每个字符，根据字符的不同来执行不同的操作：</p><ul><li>如果遇到双花括号 <code>{{</code>，则输出一个单独的花括号 <code>{</code>。</li><li>如果遇到花括号 <code>{</code>，则开始解析占位符。</li><li>占位符中可以包含占位符索引，例如 <code>{0}</code>、<code>{1}</code>，或者可以省略，例如 <code>{}</code>。</li><li>解析占位符时，首先检查是否有索引，如果没有则使用下一个可用索引。</li><li>然后根据索引查找对应的参数，并使用参数的类型的 <code>&lt;&lt;</code> 操作符将参数添加到输出流中。</li><li>如果占位符不是合法的格式，例如 <code>{10}</code>，或者没有正确的闭合括号，将会抛出异常。</li></ul><h3 id=23-函数模板-format-和-printformatted>2.3 函数模板 <code>Format</code> 和 <code>PrintFormatted</code><a hidden class=anchor aria-hidden=true href=#23-函数模板-format-和-printformatted>#</a></h3><p>这两个函数是对 <code>FormatImpl</code> 函数的封装，使其更加方便地使用。</p><ul><li><code>Format</code> 函数接受一个格式字符串和一系列参数，然后创建一个 <code>std::stringstream</code> 对象，在其中使用 <code>FormatImpl</code> 将格式化后的字符串放入流中，并返回最终的格式化结果作为一个字符串。</li><li><code>PrintFormatted</code> 函数接受一个格式字符串和一系列参数，然后直接使用 <code>FormatImpl</code> 将格式化后的内容输出到标准输出流 <code>std::cout</code>。</li></ul><p>这两个函数使得使用格式化字符串更加方便。</p><h3 id=24-测试使用>2.4 测试使用<a hidden class=anchor aria-hidden=true href=#24-测试使用>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#f92672>::</span>string yield <span style=color:#f92672>=</span> Format(<span style=color:#e6db74>&#34;a({},{},{},{})&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2.2</span>, <span style=color:#e6db74>&#39;3&#39;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>4</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string yield <span style=color:#f92672>=</span> Format(<span style=color:#e6db74>&#34;{{{0}}}&#34;</span>, <span style=color:#e6db74>&#34;text&#34;</span>);
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string yield <span style=color:#f92672>=</span> Format(<span style=color:#e6db74>&#34;{{{0}, {2}&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>, <span style=color:#e6db74>&#34;baz&#34;</span>);
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string yield <span style=color:#f92672>=</span> Format(<span style=color:#e6db74>&#34;test-{2}{1}{0}&#34;</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>33</span>);
</span></span><span style=display:flex><span>std<span style=color:#f92672>::</span>string yield <span style=color:#f92672>=</span> Format(<span style=color:#e6db74>&#34;{}{}{0}!!&#34;</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>22</span>);
</span></span></code></pre></td></tr></table></div></div><p>这个简易实现代码的问题在于它只能接受10个 id，只是在字符串语法层面完成了基础的功能，接下来我们看一下llvm format的实现。</p><h2 id=3-llvm-formatv源码分析>3. LLVM formatv源码分析<a hidden class=anchor aria-hidden=true href=#3-llvm-formatv源码分析>#</a></h2><p>LLVM formatv使用了LLVM Support 和 ADT 库做支持。这里我提供抽离出 LLVM format 组件后的仓库：<a href=https://github.com/CanftIn/formatv>https://github.com/CanftIn/formatv</a>，这个修改后的format库仅依赖于标准库，便于我们进行代码分析。</p><h3 id=31-formatvariadicdetails>3.1 FormatVariadicDetails<a hidden class=anchor aria-hidden=true href=#31-formatvariadicdetails>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// 这是一个模板结构，充当自定义的格式提供者。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 用户应该为特定的类型特化这个模板以提供格式化功能。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T, <span style=color:#66d9ef>typename</span> Enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>FormatProvider</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> Internal {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 它是一个抽象基类，定义了一个纯虚函数format。所有适配器类都需要继承这个基类并实现这个函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FormatAdapter</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> format(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, std<span style=color:#f92672>::</span>string options) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>protected</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>FormatAdapter() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> anchor() {}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ProviderFormatAdapter 和 StreamOperatorFormatAdapter 类: 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这两个类都是FormatAdapter的具体子类。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ProviderFormatAdapter使用FormatProvider为特定类型进行格式化，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 而StreamOperatorFormatAdapter则使用流插入运算符(&lt;&lt;)为类型进行格式化。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProviderFormatAdapter</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> FormatAdapter {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>explicit</span> ProviderFormatAdapter(T<span style=color:#f92672>&amp;&amp;</span> item) <span style=color:#f92672>:</span> item_(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item)) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, std<span style=color:#f92672>::</span>string options) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>    FormatProvider<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>decay_t<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;::</span>format(item_, os, options);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  T item_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StreamOperatorFormatAdapter</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> FormatAdapter {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>explicit</span> StreamOperatorFormatAdapter(T<span style=color:#f92672>&amp;&amp;</span> item)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> item_(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item)) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, std<span style=color:#f92672>::</span>string <span style=color:#75715e>/*options*/</span>) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>    os <span style=color:#f92672>&lt;&lt;</span> item_;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  T item_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MissingFormatAdapter</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T, T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SameType</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HasFormatProvider 和 HasStreamOperator 类:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这两个模板结构用于检查一个给定的类型是否有与FormatProvider或流插入运算符相关的格式化功能。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// FormatProvider should have the signature:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   static void format(const T&amp;, raw_stream &amp;, StringRef);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HasFormatProvider</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>using</span> Decayed <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>decay_t<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>using</span> SignatureFormat <span style=color:#f92672>=</span> <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>const</span> Decayed<span style=color:#f92672>&amp;</span>, std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span>, std<span style=color:#f92672>::</span>string);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> U<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> test(SameType<span style=color:#f92672>&lt;</span>SignatureFormat, <span style=color:#f92672>&amp;</span>U<span style=color:#f92672>::</span>format<span style=color:#f92672>&gt;*</span>) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>char</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> U<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> test(...) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>double</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>const</span> Value <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>sizeof</span>(test<span style=color:#f92672>&lt;</span>FormatProvider<span style=color:#f92672>&lt;</span>Decayed<span style=color:#f92672>&gt;&gt;</span>(<span style=color:#66d9ef>nullptr</span>)) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HasStreamOperator</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>using</span> ConstRefT <span style=color:#f92672>=</span> <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>decay_t<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&amp;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> U<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> test(
</span></span><span style=display:flex><span>      std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>is_same_v<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>decltype</span>(std<span style=color:#f92672>::</span>declval<span style=color:#f92672>&lt;</span>std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;&gt;</span>()
</span></span><span style=display:flex><span>                                               <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>declval<span style=color:#f92672>&lt;</span>U<span style=color:#f92672>&gt;</span>()),
</span></span><span style=display:flex><span>                                      std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;&gt;</span>,
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>int</span><span style=color:#f92672>*&gt;</span>) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>char</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> U<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> test(...) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>double</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>const</span> Value <span style=color:#f92672>=</span> (<span style=color:#66d9ef>sizeof</span>(test<span style=color:#f92672>&lt;</span>ConstRefT<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>nullptr</span>)) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Uses* 结构:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这些结构根据上面的检查，决定哪种适配器应该用于给定的类型。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UsesFormatMember</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>integral_constant<span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>bool</span>, std<span style=color:#f92672>::</span>is_base_of_v<span style=color:#f92672>&lt;</span>FormatAdapter, std<span style=color:#f92672>::</span>remove_reference_t<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;&gt;</span> {
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UsesFormatProvider</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>integral_constant<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span>, <span style=color:#f92672>!</span>UsesFormatMember<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                              HasFormatProvider<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>Value<span style=color:#f92672>&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UsesStreamOperator</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>integral_constant<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span>, <span style=color:#f92672>!</span>UsesFormatMember<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                              <span style=color:#f92672>!</span>UsesFormatProvider<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                              HasStreamOperator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>Value<span style=color:#f92672>&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UsesMissingProvider</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>integral_constant<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span>, <span style=color:#f92672>!</span>UsesFormatMember<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                              <span style=color:#f92672>!</span>UsesFormatProvider<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                              <span style=color:#f92672>!</span>HasStreamOperator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>Value<span style=color:#f92672>&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// build_format_adapter 函数模板:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这是一个函数模板的重载集合，根据对象的类型选择合适的格式适配器，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 并将对象传递给适配器进行格式化。它使用SFINAE来选择适当的重载版本，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 根据对象是否满足不同的格式化要求。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> build_format_adapter(T<span style=color:#f92672>&amp;&amp;</span> item)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span>UsesFormatMember<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value, T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> build_format_adapter(T<span style=color:#f92672>&amp;&amp;</span> item)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span>UsesFormatProvider<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value,
</span></span><span style=display:flex><span>                        ProviderFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ProviderFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> build_format_adapter(T<span style=color:#f92672>&amp;&amp;</span> item)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span>UsesStreamOperator<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value,
</span></span><span style=display:flex><span>                        StreamOperatorFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> StreamOperatorFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> build_format_adapter(T<span style=color:#f92672>&amp;&amp;</span> item)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span>UsesMissingProvider<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value,
</span></span><span style=display:flex><span>                        MissingFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> MissingFormatAdapter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(item));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}  <span style=color:#75715e>// namespace Internal
</span></span></span></code></pre></td></tr></table></div></div><p>这里先简单讲一下上面用到的适配器模式。</p><p><strong>1. 适配器模式简单示例：</strong></p><p>假设我们有一个旧的系统，其中有一个 <code>OldPrinter</code> 类可以打印简单的文本消息。现在我们想要一个新的打印机类 <code>NewPrinter</code>，它可以打印富文本。但我们不想改变旧代码。我们可以使用适配器模式来实现这一目标。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// 旧的打印机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OldPrinter</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> printSimpleMessage(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> msg) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> msg <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 新的打印机
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NewPrinter</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> printRichMessage(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> msg) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 假设这里有一些富文本处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;&lt;rich&gt;&#34;</span> <span style=color:#f92672>&lt;&lt;</span> msg <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;&lt;/rich&gt;&#34;</span> <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 适配器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrinterAdapter</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> OldPrinter {
</span></span><span style=display:flex><span>    NewPrinter newPrinter;
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> printSimpleMessage(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> msg) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>        newPrinter.printRichMessage(msg);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    PrinterAdapter adaptedPrinter;
</span></span><span style=display:flex><span>    adaptedPrinter.printSimpleMessage(<span style=color:#e6db74>&#34;Hello, Adapter Pattern!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>rich</span>&gt;Hello, Adapter Pattern!&lt;/<span style=color:#f92672>rich</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>2. 大型项目实际使用的代码例子：</strong></p><p>在大型项目中，数据库迁移是一个常见的场景。假设我们的项目最初使用 SQLite，但现在想迁移到 PostgreSQL。这两个数据库在某些查询语法上可能有所不同。我们可以使用适配器模式来确保代码的一致性。</p><p>首先，定义一个数据库接口：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Database</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> connect() <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>query</span>(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> q) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SQLite</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> Database {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 实现SQLite的具体逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PostgreSQL</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> Database {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 实现PostgreSQL的具体逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseAdapter</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> SQLite {
</span></span><span style=display:flex><span>    PostgreSQL pg;
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> connect() <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>        pg.connect();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>query</span>(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> q) <span style=color:#66d9ef>override</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可能需要将SQLite的查询语法转换为PostgreSQL的查询语法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        pg.query(convertQuery(q));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string convertQuery(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> q) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实现转换逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> q;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>在上面提供的 <code>format</code> 代码部分中，适配器模式的使用有其特定的优点：</p><ol><li><p><strong>统一格式化接口：</strong> 虽然不同的数据类型可能有不同的格式化需求和实现，但使用适配器模式可以为所有这些类型提供统一的格式化接口。这意味着无论数据类型的内部如何，调用代码只需知道如何与<code>FormatAdapter</code>接口交互。</p></li><li><p><strong>解耦：</strong> 适配器模式允许将数据类型的具体格式化逻辑从其使用方式中分离出来。这意味着，如果某个类型的格式化逻辑需要更改，那么只需要更改相应的适配器或 <code>FormatProvider</code>，而不需要更改调用格式化功能的其他部分。</p></li><li><p><strong>灵活性：</strong> 使用适配器模式，可以轻松地为不支持默认格式化（例如流运算符）的类型提供自定义的格式化方法。</p></li><li><p><strong>扩展性：</strong> 如果在未来需要添加对新的数据类型或格式化方法的支持，只需添加新的 <code>FormatProvider</code> 或适配器，而无需修改现有的调用代码。</p></li><li><p><strong>可维护性：</strong> 由于格式化逻辑与其使用方式分离，因此更容易维护。对一个类型的格式化逻辑的更改不会影响其他类型或调用代码。</p></li><li><p><strong>降低复杂性：</strong> 通过提供一个统一的接口和几个适配器，可以将复杂的格式化决策和逻辑隐藏在适配器模式的实现中，从而降低客户端代码的复杂性。</p></li><li><p><strong>更好的代码组织：</strong> 有了明确的结构和分离的职责，代码组织得更加清晰。每个适配器或 <code>FormatProvider</code> 都有其明确的目的，使得开发人员更容易理解和跟踪代码的工作方式。</p></li></ol><p>总的来说，适配器模式提供了一种灵活、扩展性强并且易于维护的方法，来处理可能存在的不同的格式化需求。</p><h3 id=32-formatalign>3.2 FormatAlign<a hidden class=anchor aria-hidden=true href=#32-formatalign>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AlignStyle</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>uint8_t</span> {
</span></span><span style=display:flex><span>  Left,    <span style=color:#75715e>// &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Center,  <span style=color:#75715e>// &#34;=&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Right,   <span style=color:#75715e>// &#34;+&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>FormatAlign</span> {
</span></span><span style=display:flex><span>  Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>&amp;</span> adapter_; <span style=color:#75715e>// 引用要格式化并对齐的FormatAdapter。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AlignStyle where_; <span style=color:#75715e>// 一个指示如何对齐输出的AlignStyle枚举值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  size_t amount_; <span style=color:#75715e>// 指示总共需要多少字符宽度的大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> fill_; <span style=color:#75715e>// 当输出的文本不足指定的字符宽度时，用来填充的字符，默认为空格。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  FormatAlign(Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>&amp;</span> adapter, AlignStyle where, size_t amount,
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>char</span> fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> adapter_(adapter), where_(where), amount_(amount), fill_(fill) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, std<span style=color:#f92672>::</span>string options) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount_ <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      adapter_.format(os, options);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ostringstream stream;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    adapter_.format(stream, options);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string item <span style=color:#f92672>=</span> stream.str();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount_ <span style=color:#f92672>&lt;=</span> item.size()) {
</span></span><span style=display:flex><span>      os <span style=color:#f92672>&lt;&lt;</span> item;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    size_t pad_amount <span style=color:#f92672>=</span> amount_ <span style=color:#f92672>-</span> item.size();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (where_) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> AlignStyle<span style=color:#f92672>::</span>Left:
</span></span><span style=display:flex><span>        os <span style=color:#f92672>&lt;&lt;</span> item;
</span></span><span style=display:flex><span>        fill(os, pad_amount);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> AlignStyle<span style=color:#f92672>::</span>Center: {
</span></span><span style=display:flex><span>        size_t x <span style=color:#f92672>=</span> pad_amount <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        fill(os, x);
</span></span><span style=display:flex><span>        os <span style=color:#f92672>&lt;&lt;</span> item;
</span></span><span style=display:flex><span>        fill(os, pad_amount <span style=color:#f92672>-</span> x);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        fill(os, pad_amount);
</span></span><span style=display:flex><span>        os <span style=color:#f92672>&lt;&lt;</span> item;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> fill(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, <span style=color:#66d9ef>uint32_t</span> count) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> count; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>      os <span style=color:#f92672>&lt;&lt;</span> fill_;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>这段代码定义了一个关于文本对齐的功能。它能够对 <code>FormatAdapter</code> 的输出进行对齐。</p><ol><li><p><strong>AlignStyle 枚举类：</strong></p><ul><li>这是一个指示对齐方式的枚举。有三种对齐方式：左对齐、居中和右对齐，它们被标记为 &ldquo;-&rdquo;, &ldquo;=&rdquo; 和 &ldquo;+"。</li></ul></li><li><p><strong>FormatAlign 结构体：</strong></p><ul><li><p>这个结构体的目的是对一个给定的 <code>FormatAdapter</code> 的输出进行对齐。</p></li><li><p><code>format</code> 方法是这个结构体的核心，它的目的是首先使用 <code>adapter_</code> 来获取要对齐的字符串，并将其对齐到指定的宽度 <code>amount_</code>。具体的对齐方式取决于 <code>where_</code> 成员的值。</p></li><li><p><code>fill</code> 是一个私有的辅助函数，用于在 <code>std::ostream</code> 中插入指定数量的 <code>fill_</code> 字符。</p></li></ul></li></ol><p>此部分代码允许用户指定文本的对齐方式和宽度，并选择填充字符。例如，用户可能希望将数字对齐到右侧，使用空格作为填充字符，以使所有数字都能在相同的宽度内对齐。</p><p>假设有一个可以使用 <code>FormatAdapter</code> 接口的数字，并且将这个数字格式化为10个字符宽，并将其居中对齐，使用 &lsquo;.&rsquo; 作为填充字符：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ostringstream num_stream;
</span></span><span style=display:flex><span>    num_stream <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>12345</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Internal<span style=color:#f92672>::</span>FormatAdapter adapter;
</span></span><span style=display:flex><span>    FormatAlign align(adapter, AlignStyle<span style=color:#f92672>::</span>Center, <span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;.&#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ostringstream final_stream;
</span></span><span style=display:flex><span>    align.format(final_stream, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> final_stream.str() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;  <span style=color:#75715e>// 输出: &#34;...12345...&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=33-formatvariadic>3.3 FormatVariadic<a hidden class=anchor aria-hidden=true href=#33-formatvariadic>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">253
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">254
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">255
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">256
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">257
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">258
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">259
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">260
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">261
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">262
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">263
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">264
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">265
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">266
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">267
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">268
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">269
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">270
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">271
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">272
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">273
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">274
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">275
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">276
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">277
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">278
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">279
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">280
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">281
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">282
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">283
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">284
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">285
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">286
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">287
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">288
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">289
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">290
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">291
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">292
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">293
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">294
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">295
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">296
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">297
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">298
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">299
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">300
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">301
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">302
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">303
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">304
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// 格式化字符串中的替换操作类型。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReplacementType</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>uint8_t</span> {
</span></span><span style=display:flex><span>  Empty, <span style=color:#75715e>// 表示没有替换。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Format, <span style=color:#75715e>// 表示应该格式化和替换的项目。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Literal, <span style=color:#75715e>// 表示应原样插入的字符串字面量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存每个替换项的格式说明详情。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>ReplacementItem</span> {
</span></span><span style=display:flex><span>  ReplacementItem() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>explicit</span> <span style=color:#a6e22e>ReplacementItem</span>(std<span style=color:#f92672>::</span>string literal)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> type(ReplacementType<span style=color:#f92672>::</span>Literal), spec(std<span style=color:#f92672>::</span>move(literal)) {}
</span></span><span style=display:flex><span>  ReplacementItem(std<span style=color:#f92672>::</span>string spec, size_t index, size_t align,
</span></span><span style=display:flex><span>                  AlignStyle where, <span style=color:#66d9ef>char</span> pad, std<span style=color:#f92672>::</span>string options)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> type(ReplacementType<span style=color:#f92672>::</span>Format),
</span></span><span style=display:flex><span>        spec(std<span style=color:#f92672>::</span>move(spec)),
</span></span><span style=display:flex><span>        index(index),
</span></span><span style=display:flex><span>        align(align),
</span></span><span style=display:flex><span>        where(where),
</span></span><span style=display:flex><span>        pad(pad),
</span></span><span style=display:flex><span>        options(std<span style=color:#f92672>::</span>move(options)) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 替换的类型。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ReplacementType type <span style=color:#f92672>=</span> ReplacementType<span style=color:#f92672>::</span>Empty;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 来自格式的原始字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  std<span style=color:#f92672>::</span>string spec;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 要替换的值的索引。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  size_t index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// align, where, pad: 对齐的规格说明。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  size_t align <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 对齐大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AlignStyle where <span style=color:#f92672>=</span> AlignStyle<span style=color:#f92672>::</span>Right; <span style=color:#75715e>// 对齐样式。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> pad <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 填充字符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 替换项的其他格式选项。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  std<span style=color:#f92672>::</span>string options;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FormatvObjectBase</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>auto</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>&lt;&lt;</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, <span style=color:#66d9ef>const</span> FormatvObjectBase<span style=color:#f92672>&amp;</span> obj)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 用于格式化对象的基类。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FormatvObjectBase</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  FormatvObjectBase(<span style=color:#66d9ef>const</span> FormatvObjectBase<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>auto</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span>(<span style=color:#66d9ef>const</span> FormatvObjectBase<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>-&gt;</span> FormatvObjectBase<span style=color:#f92672>&amp;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 根据替换项格式化字符串并将其写入给定的ostream。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>format</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os) <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> r : ParseFormatString(fmt_)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (r.type) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> ReplacementType<span style=color:#f92672>::</span>Empty:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> ReplacementType<span style=color:#f92672>::</span>Literal:
</span></span><span style=display:flex><span>          os <span style=color:#f92672>&lt;&lt;</span> r.spec;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> ReplacementType<span style=color:#f92672>::</span>Format: {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (r.index <span style=color:#f92672>&gt;=</span> adapters_.size()) {
</span></span><span style=display:flex><span>            os <span style=color:#f92672>&lt;&lt;</span> r.spec;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>auto</span><span style=color:#f92672>*</span> w <span style=color:#f92672>=</span> adapters_[r.index];
</span></span><span style=display:flex><span>          FormatAlign align(<span style=color:#f92672>*</span>w, r.where, r.align, r.pad);
</span></span><span style=display:flex><span>          align.format(os, r.options);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 解析格式字符串以获取替换项列表。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>ParseFormatString</span>(std<span style=color:#f92672>::</span>string fmt)
</span></span><span style=display:flex><span>      <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>ReplacementItem<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>ReplacementItem<span style=color:#f92672>&gt;</span> replacements;
</span></span><span style=display:flex><span>    ReplacementItem i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>fmt.empty()) {
</span></span><span style=display:flex><span>      std<span style=color:#f92672>::</span>tie(i, fmt) <span style=color:#f92672>=</span> SplitLiteralAndReplacement(fmt);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (i.type <span style=color:#f92672>!=</span> ReplacementType<span style=color:#f92672>::</span>Empty) {
</span></span><span style=display:flex><span>        replacements.push_back(i);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> replacements;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 将单个替换规格解析为ReplacementItem。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>ParseReplacementItem</span>(std<span style=color:#f92672>::</span>string spec)
</span></span><span style=display:flex><span>      <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>optional<span style=color:#f92672>&lt;</span>ReplacementItem<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 移除 spec 字符串的 { 和 }。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>string rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(spec, <span style=color:#e6db74>&#34;{}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> pad <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>size_t align <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    AlignStyle where <span style=color:#f92672>=</span> AlignStyle<span style=color:#f92672>::</span>Right;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string options;
</span></span><span style=display:flex><span>    size_t index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 移除 rep_string 的前后空白字符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(rep_string);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试从 rep_string 开始的位置解析一个整数，并将其赋值给 index。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (FormatUtil<span style=color:#f92672>::</span>ConsumeInteger(rep_string, <span style=color:#ae81ff>0</span>, index)) {
</span></span><span style=display:flex><span>      assert(false <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;Invalid replacement sequence index!&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> ReplacementItem{};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(rep_string);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 第一个字符为 `,`，它将尝试解析字段布局。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// `,`: 通常是用于字段布局或对齐的指示符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 例如，`{0,10}`，其中 0 是要替换的参数索引，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 10 是指示字段宽度或对齐的数字。`,` 符号在此处用作分隔符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>rep_string.empty() <span style=color:#f92672>&amp;&amp;</span> rep_string.front() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;,&#39;</span>) {
</span></span><span style=display:flex><span>      rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(rep_string, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>ConsumeFieldLayout(rep_string, where, align, pad)) {
</span></span><span style=display:flex><span>        assert(false <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;Invalid replacement field layout specification!&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(rep_string);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 第一个字符是否为 `:`，它会从 rep_string 中提取选项字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// `:`: 这通常是用于格式选项的指示符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 例如， `{0:0.00}`，其中 0 是要替换的参数索引，0.00 是指示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如何格式化数字的选项（例如，始终显示两位小数）。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>rep_string.empty() <span style=color:#f92672>&amp;&amp;</span> rep_string.front() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;:&#39;</span>) {
</span></span><span style=display:flex><span>      rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(rep_string, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>      options <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(rep_string);
</span></span><span style=display:flex><span>      rep_string <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rep_string <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>trim(rep_string);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>rep_string.empty()) {
</span></span><span style=display:flex><span>      assert(false <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;Unexpected characters found in replacement string!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ReplacementItem{spec, index, align, where, pad, options};
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 返回格式化的字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>str</span>() <span style=color:#66d9ef>const</span> <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>string {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>ostringstream stream;
</span></span><span style=display:flex><span>    stream <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string result <span style=color:#f92672>=</span> stream.str();
</span></span><span style=display:flex><span>    stream.flush();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 将对象转换为字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>operator</span> std<span style=color:#f92672>::</span>string() <span style=color:#66d9ef>const</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>str</span>(); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>protected</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  FormatvObjectBase(std<span style=color:#f92672>::</span>string fmt,
</span></span><span style=display:flex><span>                    ArrayRef<span style=color:#f92672>&lt;</span>Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>*&gt;</span> adapters)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> fmt_(std<span style=color:#f92672>::</span>move(fmt)), adapters_(adapters.begin(), adapters.end()) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  FormatvObjectBase(FormatvObjectBase<span style=color:#f92672>&amp;&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 解析对齐、填充和宽度规格。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>ConsumeFieldLayout</span>(std<span style=color:#f92672>::</span>string<span style=color:#f92672>&amp;</span> spec, AlignStyle<span style=color:#f92672>&amp;</span> where,
</span></span><span style=display:flex><span>                                 size_t<span style=color:#f92672>&amp;</span> align, <span style=color:#66d9ef>char</span><span style=color:#f92672>&amp;</span> pad) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    where <span style=color:#f92672>=</span> AlignStyle<span style=color:#f92672>::</span>Right;
</span></span><span style=display:flex><span>    align <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    pad <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (spec.empty()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (spec.size() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>auto</span> loc <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>TranslateLocChar(spec[<span style=color:#ae81ff>1</span>])) {
</span></span><span style=display:flex><span>        pad <span style=color:#f92672>=</span> spec[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        where <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>loc;
</span></span><span style=display:flex><span>        spec <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(spec, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>auto</span> loc <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>TranslateLocChar(spec[<span style=color:#ae81ff>0</span>])) {
</span></span><span style=display:flex><span>        where <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>loc;
</span></span><span style=display:flex><span>        spec <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(spec, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> failed <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>ConsumeInteger(spec, <span style=color:#ae81ff>0</span>, align);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span>failed;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 从输入的 fmt 字符串中分离字面量和替换项。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 即它寻找 `{...}` 结构中的替换项，并将其与其前面的字面量一起返回。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 如果找到一个连续的 `{` 或者 `{{`，它将按照适当的逻辑对其进行处理。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>SplitLiteralAndReplacement</span>(std<span style=color:#f92672>::</span>string fmt)
</span></span><span style=display:flex><span>      <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>ReplacementItem, std<span style=color:#f92672>::</span>string<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>fmt.empty()) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 处理没有 { 开头的字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (fmt.front() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;{&#39;</span>) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>size_t bo <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>find_first_of(fmt, <span style=color:#e6db74>&#39;{&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(ReplacementItem{FormatUtil<span style=color:#f92672>::</span>substr(fmt, <span style=color:#ae81ff>0</span>, bo)},
</span></span><span style=display:flex><span>                              FormatUtil<span style=color:#f92672>::</span>substr(fmt, bo));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 处理连续的 { 字符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 如果找到一个或多个 {，它会尝试获取连续的 { 个数，并将其保存在 braces 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      std<span style=color:#f92672>::</span>string braces <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          FormatUtil<span style=color:#f92672>::</span>take_while(fmt, [](<span style=color:#66d9ef>char</span> c) { <span style=color:#66d9ef>return</span> c <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;{&#39;</span>; });
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 如果连续的 `{` 个数大于1（即 `{{`），它将其解释为转义字符，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 并只保留其中一半作为字面量返回。剩下的部分被视为后续的字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (braces.size() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        size_t num_excaped_braces <span style=color:#f92672>=</span> braces.size() <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>string middle <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>take_front(fmt, num_excaped_braces);
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>string right <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(fmt, num_excaped_braces <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(ReplacementItem{middle}, right);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 查找匹配的 }。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      std<span style=color:#f92672>::</span>size_t bc <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>find_first_of(fmt, <span style=color:#e6db74>&#39;}&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (bc <span style=color:#f92672>==</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>::</span>npos) {
</span></span><span style=display:flex><span>        assert(false <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;Unterminated brace sequence.  Escape with {{ for a literal &#34;</span>
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;brace.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(ReplacementItem{fmt}, std<span style=color:#f92672>::</span>string());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 查找嵌套的 {。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      std<span style=color:#f92672>::</span>size_t bo2 <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>find_first_of(fmt, <span style=color:#e6db74>&#39;{&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (bo2 <span style=color:#f92672>&lt;</span> bc) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(ReplacementItem{FormatUtil<span style=color:#f92672>::</span>substr(fmt, <span style=color:#ae81ff>0</span>, bo2)},
</span></span><span style=display:flex><span>                              FormatUtil<span style=color:#f92672>::</span>substr(fmt, bo2));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 处理格式说明符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 在 { 和 } 之间的字符串被视为替换项的格式说明符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      std<span style=color:#f92672>::</span>string spec <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>slice(fmt, <span style=color:#ae81ff>1</span>, bc);
</span></span><span style=display:flex><span>      std<span style=color:#f92672>::</span>string right <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>substr(fmt, bc <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 调用 ParseReplacementItem 函数来解析这个说明符。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>auto</span> ri <span style=color:#f92672>=</span> ParseReplacementItem(spec);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 解析成功，它返回解析得到的 ReplacementItem 和 } 之后的字符串。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (ri) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(<span style=color:#f92672>*</span>ri, right);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 上述所有情况都没有返回结果，函数将删除 fmt 中到 bc 位置之前的所有字符，并继续循环。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      fmt <span style=color:#f92672>=</span> FormatUtil<span style=color:#f92672>::</span>drop_front(fmt, bc <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 遍历完整个 fmt 字符串仍然没有找到任何替换项，它将返回整个字符串作为字面量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>make_pair(ReplacementItem{fmt}, std<span style=color:#f92672>::</span>string());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>string fmt_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ArrayRef<span style=color:#f92672>&lt;</span>Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>*&gt;</span> adapters_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 允许直接将格式化的结果流式传输到输出流。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>auto</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>&lt;&lt;</span>(std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> os, <span style=color:#66d9ef>const</span> FormatvObjectBase<span style=color:#f92672>&amp;</span> obj)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>ostream<span style=color:#f92672>&amp;</span> {
</span></span><span style=display:flex><span>  obj.format(os);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> os;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 表示具有特定参数的格式化操作的模板类。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 它捕获格式字符串和作为元组的格式化值。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 保存每个参数的格式适配器的指针，这些适配器知道如何格式化该特定类型。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> Tuple<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FormatvObject</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> FormatvObjectBase {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  FormatvObject(std<span style=color:#f92672>::</span>string fmt, Tuple<span style=color:#f92672>&amp;&amp;</span> params)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> FormatvObjectBase(fmt, parameter_pointers_),
</span></span><span style=display:flex><span>        parameters_(std<span style=color:#f92672>::</span>move(params)),
</span></span><span style=display:flex><span>        parameter_pointers_(std<span style=color:#f92672>::</span>apply(CreateAdapters(), parameters_)) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  FormatvObject(<span style=color:#66d9ef>const</span> FormatvObject<span style=color:#f92672>&amp;</span> rhs) <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  FormatvObject(FormatvObject<span style=color:#f92672>&amp;&amp;</span> rhs)
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> FormatvObjectBase(std<span style=color:#f92672>::</span>move(rhs)),
</span></span><span style=display:flex><span>        parameters_(std<span style=color:#f92672>::</span>move(rhs.parameters_)) {
</span></span><span style=display:flex><span>    parameter_pointers_ <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>apply(CreateAdapters(), parameters_);
</span></span><span style=display:flex><span>    adapters_ <span style=color:#f92672>=</span> parameter_pointers_;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 创建格式适配器。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>CreateAdapters</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Ts<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> <span style=color:#66d9ef>operator</span>()(Ts<span style=color:#f92672>&amp;</span>... items)
</span></span><span style=display:flex><span>        <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>array<span style=color:#f92672>&lt;</span>Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>*</span>, std<span style=color:#f92672>::</span>tuple_size<span style=color:#f92672>&lt;</span>Tuple<span style=color:#f92672>&gt;::</span>value<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {{<span style=color:#f92672>&amp;</span>items...}};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Tuple parameters_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>array<span style=color:#f92672>&lt;</span>Internal<span style=color:#f92672>::</span>FormatAdapter<span style=color:#f92672>*</span>, std<span style=color:#f92672>::</span>tuple_size<span style=color:#f92672>&lt;</span>Tuple<span style=color:#f92672>&gt;::</span>value<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      parameter_pointers_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>///   // 用户创建格式化字符串的主要接口。
</span></span></span><span style=display:flex><span><span style=color:#75715e>///   // Convert to std::string.
</span></span></span><span style=display:flex><span><span style=color:#75715e>///   std::string S = formatv(&#34;{0} {1}&#34;, 1234.412, &#34;test&#34;).str();
</span></span></span><span style=display:flex><span><span style=color:#75715e>///
</span></span></span><span style=display:flex><span><span style=color:#75715e>///   OS &lt;&lt; formatv(&#34;{0} {1}&#34;, 1234.412, &#34;test&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span>... Ts<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>auto</span> formatv(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> fmt, Ts<span style=color:#f92672>&amp;&amp;</span>... vals)
</span></span><span style=display:flex><span>    <span style=color:#f92672>-&gt;</span> FormatvObject<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>decltype</span>(std<span style=color:#f92672>::</span>make_tuple(
</span></span><span style=display:flex><span>        Internal<span style=color:#f92672>::</span>build_format_adapter(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Ts<span style=color:#f92672>&gt;</span>(vals))...))<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>using</span> ParamTuple <span style=color:#f92672>=</span> <span style=color:#66d9ef>decltype</span>(std<span style=color:#f92672>::</span>make_tuple(
</span></span><span style=display:flex><span>      Internal<span style=color:#f92672>::</span>build_format_adapter(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Ts<span style=color:#f92672>&gt;</span>(vals))...));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> FormatvObject<span style=color:#f92672>&lt;</span>ParamTuple<span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>      fmt, std<span style=color:#f92672>::</span>make_tuple(
</span></span><span style=display:flex><span>               Internal<span style=color:#f92672>::</span>build_format_adapter(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Ts<span style=color:#f92672>&gt;</span>(vals))...));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>单独对 <code>SplitLiteralAndReplacement</code> 函数中多个连续<code>{</code>，只保留其中一半作为字面量返回的原因：</p><p>这种处理方式是为了使得格式化字符串中可以包含字面量的大括号 <code>{</code> 和 <code>}</code>。在许多格式化库中，<code>{</code> 和 <code>}</code> 用于定义变量替换的位置，但如果你真的想在结果字符串中包含一个 <code>{</code> 或 <code>}</code> 怎么办呢？这时，你就需要一种方法来"转义"这些特殊字符，使它们被解释为普通字符。</p><p>为了实现这一目的，这段代码使用了一个简单的规则：连续的两个 <code>{</code> 被解释为一个字面量的 <code>{</code>。同样，连续的两个 <code>}</code> 被解释为一个字面量的 <code>}</code>。</p><p>考虑以下格式化字符串：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&#34;Hello {{name}}! The braces are: {{ and }}&#34;
</span></span></code></pre></td></tr></table></div></div><p>在这个字符串中，<code>{{name}}</code> 是一个变量替换，而连续的 <code>{{</code> 和 <code>}}</code> 是转义的大括号。当这个格式化字符串被处理时，它应该产生以下输出（假设 <code>name</code> 被替换为 &ldquo;Alice&rdquo;）：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&#34;Hello Alice! The braces are: { and }&#34;
</span></span></code></pre></td></tr></table></div></div><p>所以，连续的 <code>{{</code> 被解释为单个的 <code>{</code>，连续的 <code>}}</code> 被解释为单个的 <code>}</code>，这就是为什么只保留一半的原因。</p><h3 id=34-format>3.4 Format<a hidden class=anchor aria-hidden=true href=#34-format>#</a></h3><p>Format 接口不做赘述，主要使用 <code>std::snprintf</code> 作为内部输出函数，主体实现方式和 <code>FormatVariadic</code> 类似。</p><p>至此对llvm中format部分的分析结束。</p><h2 id=4-引用>4. 引用<a hidden class=anchor aria-hidden=true href=#4-引用>#</a></h2><p>[1]. <a href=https://zh.cppreference.com/w/cpp/header/format>https://zh.cppreference.com/w/cpp/header/format</a></p><p>[2]. <a href=https://llvm.org/docs/ProgrammersManual.html#formatting-strings-the-formatv-function>https://llvm.org/docs/ProgrammersManual.html#formatting-strings-the-formatv-function</a></p><p>[3]. <a href=https://github.com/CanftIn/formatv>https://github.com/CanftIn/formatv</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://canftin.github.io/posts/tech/p9_compiler_build_8_parse_tree/><span class=title>Next »</span><br><span>从零构造现代语言编译器(8): 解析树</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
2016-2023
<a href=https://github.com/canftin style=color:#939393>CanftIn</a>
, 许可协议：<a class=link href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-ND 4.0</a>,</span>
<span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function n(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)})})</script></body></html>